-- Update subprojects details JSONB structure to include separated actual financial fields
-- This iterates over the details array in each subproject row and adds 'actualObligationAmount' and 'actualDisbursementAmount' keys to each object.
-- It defaults 'actualObligationAmount' to 0 and 'actualDisbursementAmount' to the old 'actualAmount' value (or 0 if null).

UPDATE subprojects
SET details = (
  SELECT jsonb_agg(
    elem || jsonb_build_object(
      'actualObligationAmount', COALESCE((elem->>'actualObligationAmount')::numeric, 0),
      'actualDisbursementAmount', COALESCE((elem->>'actualDisbursementAmount')::numeric, (elem->>'actualAmount')::numeric, 0)
    )
  )
  FROM jsonb_array_elements(details) elem
);