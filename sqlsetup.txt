
-- Enable UUID extension if not already enabled
create extension if not exists "uuid-ossp";

-- 1. Subprojects Table
create table if not exists subprojects (
  "id" bigint primary key generated always as identity
);

-- Ensure all columns exist for Subprojects
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "uid" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "name" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "location" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "indigenousPeopleOrganization" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "ipo_id" bigint;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "status" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "details" jsonb default '[]'::jsonb;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "subprojectCommodities" jsonb default '[]'::jsonb;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "packageType" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "startDate" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "estimatedCompletionDate" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "actualCompletionDate" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "remarks" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "lat" numeric;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "lng" numeric;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "history" jsonb default '[]'::jsonb;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "fundingYear" integer;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "fundType" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "tier" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "operatingUnit" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "encodedBy" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "catchUpPlanRemarks" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "newTargetCompletionDate" text;
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE subprojects ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 2. IPOs Table
create table if not exists ipos (
  "id" bigint primary key generated always as identity
);

-- Ensure all columns exist for IPOs (Fixes 'ancestralDomainNo' missing error)
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "name" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "location" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "region" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "indigenousCulturalCommunity" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "ancestralDomainNo" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "registeringBody" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "isWomenLed" boolean;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "isWithinGida" boolean;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "isWithinElcac" boolean;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "isWithScad" boolean;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "contactPerson" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "contactNumber" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "registrationDate" text;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "commodities" jsonb default '[]'::jsonb;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "levelOfDevelopment" integer;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "history" jsonb default '[]'::jsonb;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "lat" numeric;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "lng" numeric;
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE ipos ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 3. Activities Table (Covers Trainings and Other Activities)
create table if not exists activities (
  "id" bigint primary key generated always as identity
);

ALTER TABLE activities ADD COLUMN IF NOT EXISTS "uid" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "type" text; -- 'Training' or 'Activity'
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "name" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "date" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "description" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "location" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "facilitator" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "participatingIpos" jsonb default '[]'::jsonb;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "participating_ipo_ids" jsonb default '[]'::jsonb;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "lat" numeric;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "lng" numeric;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "participantsMale" integer;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "participantsFemale" integer;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "expenses" jsonb default '[]'::jsonb;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "component" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "fundingYear" integer;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "fundType" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "tier" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "operatingUnit" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "encodedBy" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "catchUpPlanRemarks" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "newTargetDate" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "actualDate" text;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "actualParticipantsMale" integer;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "actualParticipantsFemale" integer;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE activities ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 4. Program Management: Office Requirements
create table if not exists office_requirements (
  "id" bigint primary key generated always as identity
);

ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "uid" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "operatingUnit" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "uacsCode" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "obligationDate" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "disbursementDate" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "fundType" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "fundYear" integer;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "tier" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "encodedBy" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "actualDate" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "actualAmount" numeric;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "actualObligationDate" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "actualDisbursementDate" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "actualObligationAmount" numeric;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "actualDisbursementAmount" numeric;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "equipment" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "specs" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "purpose" text;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "numberOfUnits" numeric;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "pricePerUnit" numeric;
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE office_requirements ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 5. Program Management: Staffing Requirements
create table if not exists staffing_requirements (
  "id" bigint primary key generated always as identity
);

ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "uid" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "operatingUnit" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "uacsCode" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "obligationDate" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "disbursementDate" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "fundType" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "fundYear" integer;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "tier" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "encodedBy" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "actualDate" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "actualAmount" numeric;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "actualObligationDate" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "actualDisbursementDate" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "actualObligationAmount" numeric;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "actualDisbursementAmount" numeric;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "personnelPosition" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "status" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "salaryGrade" integer;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "annualSalary" numeric;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "personnelType" text;
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE staffing_requirements ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 6. Program Management: Other Expenses
create table if not exists other_program_expenses (
  "id" bigint primary key generated always as identity
);

ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "uid" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "operatingUnit" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "uacsCode" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "obligationDate" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "disbursementDate" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "fundType" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "fundYear" integer;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "tier" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "encodedBy" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "actualDate" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "actualAmount" numeric;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "actualObligationDate" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "actualDisbursementDate" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "actualObligationAmount" numeric;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "actualDisbursementAmount" numeric;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "particulars" text;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "amount" numeric;
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE other_program_expenses ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 7. References: UACS
create table if not exists reference_uacs (
  "id" text primary key
);
ALTER TABLE reference_uacs ADD COLUMN IF NOT EXISTS "objectType" text;
ALTER TABLE reference_uacs ADD COLUMN IF NOT EXISTS "particular" text;
ALTER TABLE reference_uacs ADD COLUMN IF NOT EXISTS "uacsCode" text;
ALTER TABLE reference_uacs ADD COLUMN IF NOT EXISTS "description" text;

-- 8. References: Particulars
create table if not exists reference_particulars (
  "id" text primary key
);
ALTER TABLE reference_particulars ADD COLUMN IF NOT EXISTS "type" text;
ALTER TABLE reference_particulars ADD COLUMN IF NOT EXISTS "particular" text;

-- 9. Users
create table if not exists users (
  "id" bigint primary key generated always as identity
);
ALTER TABLE users ADD COLUMN IF NOT EXISTS "username" text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS "fullName" text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS "email" text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS "role" text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS "operatingUnit" text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS "password" text;
ALTER TABLE users ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();
ALTER TABLE users ADD COLUMN IF NOT EXISTS "updated_at" timestamptz default now();

-- 10. Deadlines
create table if not exists deadlines (
  "id" bigint primary key generated by default as identity
);
ALTER TABLE deadlines ADD COLUMN IF NOT EXISTS "name" text;
ALTER TABLE deadlines ADD COLUMN IF NOT EXISTS "date" text;
ALTER TABLE deadlines ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();

-- 11. Planning Schedules
create table if not exists planning_schedules (
  "id" bigint primary key generated by default as identity
);
ALTER TABLE planning_schedules ADD COLUMN IF NOT EXISTS "name" text;
ALTER TABLE planning_schedules ADD COLUMN IF NOT EXISTS "startDate" text;
ALTER TABLE planning_schedules ADD COLUMN IF NOT EXISTS "endDate" text;
ALTER TABLE planning_schedules ADD COLUMN IF NOT EXISTS "created_at" timestamptz default now();

-- ================================================================
-- ROW LEVEL SECURITY POLICIES
-- ================================================================
-- Note: Supabase enables RLS by default. Since this app uses a custom
-- authentication scheme (users table) instead of Supabase Auth, requests
-- come from the 'anon' role. We must allow access for the app to function.

-- Users Table
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
-- Drop existing policy if exists to avoid conflicts when re-running
DROP POLICY IF EXISTS "Public Access Users" ON users;
CREATE POLICY "Public Access Users" ON users FOR ALL USING (true) WITH CHECK (true);

-- Subprojects
ALTER TABLE subprojects ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Subprojects" ON subprojects;
CREATE POLICY "Public Access Subprojects" ON subprojects FOR ALL USING (true) WITH CHECK (true);

-- IPOs
ALTER TABLE ipos ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access IPOs" ON ipos;
CREATE POLICY "Public Access IPOs" ON ipos FOR ALL USING (true) WITH CHECK (true);

-- Activities
ALTER TABLE activities ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Activities" ON activities;
CREATE POLICY "Public Access Activities" ON activities FOR ALL USING (true) WITH CHECK (true);

-- Program Management Tables
ALTER TABLE office_requirements ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access OR" ON office_requirements;
CREATE POLICY "Public Access OR" ON office_requirements FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE staffing_requirements ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access SR" ON staffing_requirements;
CREATE POLICY "Public Access SR" ON staffing_requirements FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE other_program_expenses ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access OE" ON other_program_expenses;
CREATE POLICY "Public Access OE" ON other_program_expenses FOR ALL USING (true) WITH CHECK (true);

-- References
ALTER TABLE reference_uacs ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access UACS" ON reference_uacs;
CREATE POLICY "Public Access UACS" ON reference_uacs FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE reference_particulars ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Particulars" ON reference_particulars;
CREATE POLICY "Public Access Particulars" ON reference_particulars FOR ALL USING (true) WITH CHECK (true);

-- System Settings (Deadlines & Planning Schedules)
ALTER TABLE deadlines ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Deadlines" ON deadlines;
CREATE POLICY "Public Access Deadlines" ON deadlines FOR ALL USING (true) WITH CHECK (true);

ALTER TABLE planning_schedules ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Public Access Planning Schedules" ON planning_schedules;
CREATE POLICY "Public Access Planning Schedules" ON planning_schedules FOR ALL USING (true) WITH CHECK (true);
